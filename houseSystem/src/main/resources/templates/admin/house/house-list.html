<!DOCTYPE html>
<html class="x-admin-sm" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <title>欢迎页面-X-admin2.1</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport"
          content="width=device-width,user-scalable=yes, minimum-scale=0.4, initial-scale=0.8,target-densitydpi=low-dpi"/>
    <link rel="stylesheet" href="/admin/css/font.css" th:href="@{/admin/css/font.css}">
    <link rel="stylesheet" href="/admin/css/xadmin.css" th:href="@{/admin/css/xadmin.css}">
    <script type="text/javascript" src="/Jquery/3.2.1/jquery.min.js" th:src="@{/Jquery/3.2.1/jquery.min.js}"></script>
    <script src="/layui/layui.js" charset="utf-8" th:src="@{/layui/layui.js}"></script>
    <script type="text/javascript" src="/admin/js/xadmin.js" th:src="@{/admin/js/xadmin.js}"></script>
    <script type="text/javascript" src="/admin/js/cookie.js" th:src="@{/admin/js/cookie.js}"></script>
    <script type="text/javascript" src="/admin/js/xconfig.js" th:src="@{/admin/js/cookie.js}"></script>
    <!-- 让IE8/9支持媒体查询，从而兼容栅格 -->
    <!--[if lt IE 9]>
    <script src="https://cdn.staticfile.org/html5shiv/r29/html5.min.js"></script>
    <script src="https://cdn.staticfile.org/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>

<body>
<div class="x-nav">
      <span class="layui-breadcrumb">
        <a href="">首页</a>
        <a href="">演示</a>
        <a>
          <cite>导航元素</cite></a>
      </span>
    <a class="layui-btn layui-btn-small" style="line-height:1.6em;margin-top:3px;float:right"
       href="javascript:location.replace(location.href);" title="刷新">
        <i class="layui-icon" style="line-height:30px">ဂ</i></a>
</div>
<div class="x-body">
    <div class="layui-row">
        <form class="layui-form layui-col-md12 x-so">
            <input class="layui-input" placeholder="开始日" name="start" id="start">
            <input class="layui-input" placeholder="截止日" name="end" id="end">
            <div class="layui-input-inline">
                <select name="contrller">
                    <option>支付状态</option>
                    <option>已支付</option>
                    <option>未支付</option>
                </select>
            </div>
            <div class="layui-input-inline">
                <select name="contrller">
                    <option>支付方式</option>
                    <option>支付宝</option>
                    <option>微信</option>
                    <option>货到付款</option>
                </select>
            </div>
            <div class="layui-input-inline">
                <select name="contrller">
                    <option value="">订单状态</option>
                    <option value="0">待确认</option>
                    <option value="1">已确认</option>
                    <option value="2">已收货</option>
                    <option value="3">已取消</option>
                    <option value="4">已完成</option>
                    <option value="5">已作废</option>
                </select>
            </div>
            <input type="text" name="username" placeholder="请输入订单号" autocomplete="off" class="layui-input">
            <button class="layui-btn" lay-submit="" lay-filter="sreach"><i class="layui-icon">&#xe615;</i></button>
        </form>
    </div>
    <xblock>
        <button class="layui-btn layui-btn-danger" onclick="delAll()"><i class="layui-icon"></i>批量删除</button>
        <button class="layui-btn" onclick="x_admin_show('添加用户','./order-add.html')"><i class="layui-icon"></i>添加
        </button>
    </xblock>
    <script type="text/html" id="bar">
        <a class="layui-btn layui-btn-primary layui-btn-xs" lay-event="detail">查看</a>
        <a class="layui-btn layui-btn-xs" lay-event="edit">编辑</a>
        <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">删除</a>
    </script>


    <script type="text/html" id="status1">
        <input type="checkbox" name="status" value="{{d.id}}" title="出租状态" lay-filter="status1" {{ d.status>=2
        ? 'checked' : '' }}>
    </script>
    <script type="text/html" id="status2">
        <input type="checkbox" name="status" value="{{d.id}}" title="认证状态" lay-filter="status2" {{
               d.status>= 1 ? 'checked' : '' }}>
    </script>
    <script type="text/html" id="img">
        {{#  if(d.pics && d.pics != ""){ }}
        <img
                src={{=d.pics}} width="100%"
                height="100%" onclick="previewImg(this)"
        >
        {{#  }else{ }}
        无数据
        {{# } }}
    </script>


    <table id="house" lay-filter="house"></table>

</div>
<script>
    layui.use('laydate', function () {
        var laydate = layui.laydate;

        //执行一个laydate实例
        laydate.render({
            elem: '#start' //指定元素
        });

        //执行一个laydate实例
        laydate.render({
            elem: '#end' //指定元素
        });
    });

    /*用户-停用*/
    function member_stop(obj, id) {
        layer.confirm('确认要停用吗？', function (index) {

            if ($(obj).attr('title') == '启用') {

                //发异步把用户状态进行更改
                $(obj).attr('title', '停用')
                $(obj).find('i').html('&#xe62f;');

                $(obj).parents("tr").find(".td-status").find('span').addClass('layui-btn-disabled').html('已停用');
                layer.msg('已停用!', {icon: 5, time: 1000});

            } else {
                $(obj).attr('title', '启用')
                $(obj).find('i').html('&#xe601;');

                $(obj).parents("tr").find(".td-status").find('span').removeClass('layui-btn-disabled').html('已启用');
                layer.msg('已启用!', {icon: 5, time: 1000});
            }

        });
    }

    /*用户-删除*/
    function member_del(obj, id) {
        layer.confirm('确认要删除吗？', function (index) {
            //发异步删除数据
            $(obj).parents("tr").remove();
            layer.msg('已删除!', {icon: 1, time: 1000});
        });
    }


    function delAll(argument) {

        var data = tableCheck.getData();

        layer.confirm('确认要删除吗？' + data, function (index) {
            //捉到所有被选中的，发异步进行删除
            layer.msg('删除成功', {icon: 1});
            $(".layui-form-checked").not('.header').parents('tr').remove();
        });
    }

    layui.use(['table', 'jquery', 'form', 'upload', 'xajax'], function () {
        let table = layui.table,
            form = layui.form,
            $ = layui.jquery,
            upload = layui.upload,
            xajax = layui.xajax;
        let url = 'http://test.sunxiaoyuan.com:8080/house/list';
        xajax.error_token('/index/login');
        let token = xajax.get_token();
        let seach = xajax.get_cache('SEARCH');
        if (seach === null || typeof seach === 'undefined') {
            $.ajax({
                async: false,
                url: '/json/search.json',
                type: 'GET',
                success: function (res) {
                    seach = res.data;
                    xajax.set_cache('SEARCH', res.data, 6);
                }
            });
        }
        xajax.formatDate();
        let retable = table.render({
            elem: '#house'//表格绑定 根据id绑定
            , url: url //请求地址
            , method: 'POST'//请求方法
            , where: {"access_token": token.access_token}
            , toolbar: '#toolbar' //开启表格头部工具栏区域 左边图标
            , title: '房东房屋表格'//定义 table 的大标题（在文件导出等地方会用到
            , totalRow: false // 开启合计行
            , request: {
                pageName: 'pageNum' //页码的参数名称，默认：page
                , limitName: 'pageSize' //每页数据量的参数名，默认：limit
            },
            parseData: function (res) { //res 即为原始返回的数据
                let list = res.data[0].list;
                for (let i = 0, len = list.length; i < len; i++) {
                    if (list[i].pics !== null && list[i].pics.length !== 0) {
                        res.data[0].list[i].pics = res.data[0].list[i].pics[0].url
                    } else {
                        res.data[0].list[i].pics = '/images/temp/property_01.jpg'
                    }
                }
                return {
                    "code": res.code, //解析接口状态
                    "msg": res.msg, //解析提示文本
                    "count": res.data[0].total, //解析数据长度
                    "data": res.data[0].list //解析数据列表
                };
            }
            , response: {
                statusCode: 200 //规定成功的状态码，默认：0
            }
            , cols: [
                [
                    {type: 'checkbox', fixed: 'left'}
                    , {
                    field: 'id',
                    title: '房屋编号',
                    width: 100,
                    fixed: 'left',
                    unresize: true,//不可编辑
                    sort: true,//排序
                    totalRowText: '合计'
                }
                    , {field: 'user_id', title: '主人编号', width: 100}
                    , {
                    field: 'addr_id', title: '区域', width: 100, templet: function (d) {
                        for (let key in seach.areas) {
                            if (key == d.addr_id) {
                                return seach.areas[key];
                            }
                        }
                    }
                },
                    {
                        field: 'pics',
                        title: '图片',
                        width: 80,
                        templet: '#img'
                    }
                    , {field: 'addr_detail', title: '房屋地址', width: 100}

                    , {field: 'area', title: '房屋面积', width: 100, sort: true}
                    , {field: 'title', title: '房屋名称', width: 100}
                    , {field: 'info', title: '房屋设施', width: 100}
                    , {field: 'rent', title: '租金', width: 80, sort: true}
                    , {
                    field: 'style', title: '风格', width: 80, sort: true, templet: function (d) {
                        for (let key in seach.style) {
                            if (key == d.style) {
                                return seach.style[key];
                            }
                        }
                    }
                }
                    , {field: 'pay_a', title: '押金数', width: 90, align: 'center'}
                    , {field: 'pay_b', title: '缴费数', width: 90, align: 'center'}
                    , {field: 'type_a', title: '房间数', width: 90, align: 'center'}
                    , {field: 'type_b', title: '客厅数', width: 90, align: 'center'}
                    , {field: 'type_c', title: '卫生间数', width: 90, align: 'center'}
                    , {field: 'type_d', title: '厨房数', width: 90, align: 'center'}
                    , {
                    field: 'create_time',
                    title: '发布时间',
                    width: 200,
                    sort: true,
                    align: 'center',
                    templet: function (d) {
                        return new Date(d.create_time).format('yyyy-MM-dd hh:mm:ss');
                    }
                }

                    , {field: 'status', title: '出租状态', width: 130, sort: true, templet: '#status1'}
                    , {field: 'status', title: '认证状态', width: 130, sort: true, templet: '#status2'}
                    , {fixed: 'right', title: '操作', align: 'center', toolbar: '#bar', width: 200}
                ]
            ]
            , page: true //分页开关
            , loading: false
        });

        //工具栏事件
        table.on('toolbar(house)', function (obj) {
            let checkStatus = table.checkStatus(obj.config.id);
            switch (obj.event) {
                case 'flush':
                    retable.reload();
                    break;
            }
        });
        //监听行工具事件
        //右侧
        table.on('tool(house)', function (obj) {
            let data = obj.data;
            switch (obj.event) {
                case 'del':
                    layer.confirm('真的删除行么', function (index) {
                        obj.del();
                        layer.close(index);
                    });
                    break;
                case 'edit':
                    layer.open({
                        type: 1
                        , shade: 0.8
                        , offset: 'auto'
                        , content: $('#formedit')
                        , area: ['600px', '600px']
                        , shadeClose: true//点击外围关闭弹窗
                        , title: "编辑内容" //不显示标题
                        , success: function (layero, index) {
                            let seach = get_localStorage('SEARCH');
                            let valdata = res_Apd_update_seach(data, seach);
                            form.val("formedit", {
                                "houseid": data.houseid // "name": "value"
                                , 'housename': data.housename
                                , 'area': valdata.area
                                , "housestyle": data.housestyle
                                , "houseaddress": data.houseaddress
                                , "housearea": data.housearea
                                , "housefaci": data.housefaci
                                , "zent": data.zent
                                , "style": valdata.style
                                , "payway": valdata.payway
                                , "housedate": valdata.style
                            });
                            //表单提交
                            form.on('submit(up)', function (updata_data) {
                                let token = get_localStorage('TOKEN');
                                console.log(updata_data.field); //当前容器的全部表单字段，名值对形式：{name: value}
                                let sum_data = Apd_update_submit(updata_data.field);
                                let parm = Object.assign(sum_data, {'access_token': token.access_token});
                                $.ajax({
                                    // url: '/test',
                                    type: 'POST',
                                    data: parm,
                                    success: function (res) {
                                        if (res === 200) {
                                            layer.msg('修改成功', {icon: 1, time: 2000}, function () {
                                                update_obj(updata_data.field);
                                                layer.close(index);
                                            });
                                        }
                                    },
                                    error: function (res) {
                                        layer.msg('修改失败，意外意外', {icon: 1, time: 2000}, function () {
                                            layer.close(index);
                                        });
                                    }
                                });

                                function update_obj(data) {
                                    //将区域数字转换为字符
                                    let Apd_update_Data = Apd_update_seach(data, seach);
                                    //更新缓存里面的值
                                    obj.update({
                                        "houseid": data.houseid // "name": "value"
                                        , 'housename': data.housename
                                        , 'area': Apd_update_Data.area
                                        , "housestyle": Apd_update_Data.housestyle
                                        , "houseaddress": data.houseaddress
                                        , "housearea": data.housearea
                                        , "housefaci": data.housefaci
                                        , "zent": data.zent
                                        , "style": Apd_update_Data.style
                                        , "payway": Apd_update_Data.payway
                                        , "housedate": data.housedate
                                    });

                                }

                                return false; //阻止表单跳转。如果需要表单跳转，去掉这段即可。
                            });
                        }
                    });
                    break;
                case 'attestation':
                    layer.open({
                        type: 1,
                        shade: 0.8,
                        offset: 'auto',
                        area: [250 + 'px', 200 + 'px'],
                        shadeClose: true,//点击外围关闭弹窗
                        scrollbar: false,//不现实滚动条
                        title: "文件上传", //不显示标题
                        content: $('#file'), //捕获的元素，注意：最好该指定的元素要存放在body最外层，否则可能被其它的相对元素所影响
                    });
                    uploadData(data);
                    break;
            }
        });

        //监听出租状态锁定操作
        form.on('checkbox(status1)', function (obj) {
            // {"access_token": token.access_token}
            layer.tips(this.value + ' ' + this.name + '：' + obj.elem.checked, obj.othis);
        })
        // 监听认证状态锁定操作
        form.on('checkbox(status2)', function (obj) {
            layer.tips(this.value + ' ' + this.name + '：' + obj.elem.checked, obj.othis);
        });

    });

    function previewImg(obj) {
        let img = new Image();
        img.src = obj.src;
        let height = img.height + 50; //获取图片高度
        let width = img.width; //获取图片宽度
        let imgHtml = "<img src='" + obj.src + "' width='500px' height='500px'/>";
        layui.use('layer', function () {
            let layer = layui.layer;
            //弹出层
            let index = layer.open({
                type: 1,
                shade: 0.8,
                offset: 'auto',
                area: [500 + 'px', 550 + 'px'],
                shadeClose: true,//点击外围关闭弹窗
                scrollbar: false,//不现实滚动条
                title: "图片预览", //不显示标题
                content: imgHtml, //捕获的元素，注意：最好该指定的元素要存放在body最外层，否则可能被其它的相对元素所影响
                cancel: function (index, layero) {
                    layer.close(index);
                },
                end: function () {
                    if (layer.index > 0) {
                        layer.close(layer.index);
                    }
                }
            });
            setTimeout(function () {
                layer.close(index);
            }, 10000)
        });
    }

</script>
</body>

</html>